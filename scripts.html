<!-- scripts.html -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  const ROUTES = {
    'home': 'index',
    'structure': 'structure',
    'fmamunicipalities': 'fmamunicipalities',
    'activities': 'activities',
    'directory': 'directory',
    'references': 'references',
    'search': 'search',
    'about': 'about',
    'learnmore': 'learnmore',
    'fmaprofile': 'fmaprofile'
  };
  let currentToast = null;
  let currentDirType = 'internal';

  function showToast(message, type = 'success', delay = 4000) {
    const toastEl = document.getElementById('app-toast');
    toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
    toastEl.querySelector('.toast-body').textContent = message;
    const toast = new bootstrap.Toast(toastEl, { delay });
    toast.show();
    currentToast = toast;
  }

  function loadPage(page) {
    const valid = ['index', 'structure', 'fmamunicipalities', 'activities', 'directory', 'references', 'about', 'learnmore'];
    if (!valid.includes(page)) page = 'index';

    google.script.run
      .withSuccessHandler(html => {
        document.getElementById('page-content').innerHTML = html;
        history.pushState({ page }, '', '#' + page);
        // Re-run page-specific scripts
        if (window[`load${page.charAt(0).toUpperCase() + page.slice(1)}`]) {
          window[`load${page.charAt(0).toUpperCase() + page.slice(1)}`]();
        }
      })
      .getPage(page);
  }

  function callServer(fn, args = [], timeout = 15000) {
    return new Promise((resolve, reject) => {
      const timer = setTimeout(() => reject(new Error('Request timeout after 15s')), timeout);
      google.script.run
        .withSuccessHandler(res => { clearTimeout(timer); resolve(res); })
        .withFailureHandler(err => { clearTimeout(timer); reject(err); })
      [fn](...args);
    }).catch(err => {
      console.error('Server error:', err);
      showToast(err.message || 'Server error occurred', 'danger');
      throw err;
    });
  }

  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function formatDate(dateStr) {
    try {
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    } catch { return dateStr; }
  }

  function navigate(hash) {
    if (!hash) hash = '#home';
    const page = hash.split('?')[0].replace('#', '') || 'home';
    const route = ROUTES[page] || 'index';
    const main = document.getElementById('page-content');
    
    if (!main) {
      console.error('Page content container not found');
      return;
    }
    
    // Store current page in localStorage for refresh persistence
    try {
      localStorage.setItem('lastPage', hash);
    } catch (e) {
      console.warn('localStorage not available:', e);
    }
    
    main.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';

    google.script.run
      .withSuccessHandler(html => {
        main.innerHTML = html;
        // Update URL without triggering navigation
        if (window.history && window.history.pushState) {
          window.history.pushState({ page }, '', hash);
        }
        initPage(page, hash);
        document.documentElement.scrollTop = 0;
      })
      .withFailureHandler(err => {
        main.innerHTML = `<div class="alert alert-danger">Failed to load page: ${escapeHtml(err.message)}</div>`;
      })
      .getPageContent(route);
  }

  window.addEventListener('popstate', e => navigate(location.hash));
  document.addEventListener('click', e => {
    if (e.target.matches('a[href^="#"]') && !e.target.getAttribute('target')) {
      e.preventDefault();
      navigate(e.target.getAttribute('href'));
    }
  });

  function initPage(page, hash) {
    updateActiveNavLink(page);
    if (page === 'home') { loadQuickStats(); loadRecentActivities(); }
    // Structure page is now static, no need to load data dynamically
    // if (page === 'structure') loadStructure();
    if (page === 'activities') loadActivities();
    if (page === 'directory') loadDirectory('internal');
    if (page === 'references') loadReferences();
    if (page === 'search') loadSearchResults(hash);
    if (page === 'learnmore') {
      // Learn more page is static, no dynamic loading needed
    }
    if (page === 'fmaprofile') loadFMAProfile();
  }

  function updateActiveNavLink(page) {
    // Remove active class from all links
    document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
      link.classList.remove('active');
    });

    // Add active class to the current page link
    // Handle 'home' mapping to #home or empty hash
    const targetHref = page === 'home' ? '#home' : '#' + page;
    const activeLink = document.querySelector(`.navbar-nav .nav-link[href="${targetHref}"]`);

    if (activeLink) {
      activeLink.classList.add('active');
    }
  }

  async function loadQuickStats() {
    try {
      const stats = await callServer('getQuickStats');
      ['internal', 'activities', 'files'].forEach(k => {
        const el = document.getElementById(`stat-${k}`);
        if (el) el.textContent = stats[`${k}Count`] || 0;
      });
    } catch (err) { }
  }

  async function loadRecentActivities() {
    const container = document.getElementById('recent-activities');

    try {
      const data = await callServer('getActivities');
      const recent = data
        .sort((a, b) => new Date(b.DATE_CONDUCTED) - new Date(a.DATE_CONDUCTED))
        .slice(0, 3);

      if (recent.length === 0) {
        container.innerHTML = `
          <div class="col-12 text-center py-5 text-muted">
            <i class="bi bi-calendar-x display-1 opacity-50"></i>
            <h5 class="mt-4">No activities recorded yet</h5>
            <p>Check back soon for updates!</p>
          </div>
        `;
        return;
      }

      container.innerHTML = recent.map(act => `
        <div class="col-md-6 col-lg-4">
          <div class="card h-100 border-0 shadow-lg rounded-4 overflow-hidden transition-all hover-lift recent-activity-card" style="transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">
            <!-- Footer-colored Header -->
            <div class="card-header border-0 p-0" style="background: var(--primary-dark); height: 4px;"></div>
            
            <div class="card-body p-4 d-flex flex-column">
              <!-- Date Badge -->
              <div class="mb-3">
                <span class="badge rounded-pill px-3 py-2 text-white" style="background: var(--primary-dark); font-weight: 600;">
                  <i class="bi bi-calendar3-event me-1"></i>
                  ${formatDate(act.DATE_CONDUCTED)}
                </span>
              </div>
              
              <!-- Activity Title -->
              <div class="mb-3">
                <label class="small text-muted fw-semibold text-uppercase mb-1" style="font-size: 0.75rem; letter-spacing: 0.5px;">Activity Title</label>
                <h5 class="card-title fw-bold text-dark mb-0" style="font-size: 1.1rem; line-height: 1.4; min-height: 2.8em;">
                  ${escapeHtml(act.ACTIVITY_TITLE)}
                </h5>
              </div>

              <!-- Details Section -->
              <div class="flex-grow-1 mb-3">
                <!-- Location -->
                <div class="mb-3">
                  <label class="small text-muted fw-semibold text-uppercase mb-1 d-flex align-items-center" style="font-size: 0.75rem; letter-spacing: 0.5px;">
                    <i class="bi bi-geo-alt-fill me-1" style="color: var(--primary-dark);"></i>
                    Location
                  </label>
                  <div class="text-muted small">
                    ${escapeHtml(act.LOCATION || 'Location not specified')}
                  </div>
                </div>

                <!-- Resource Person -->
                ${act.RESOURCE_PERSON ? `
                  <div>
                    <label class="small text-muted fw-semibold text-uppercase mb-1 d-flex align-items-center" style="font-size: 0.75rem; letter-spacing: 0.5px;">
                      <i class="bi bi-person-circle me-1" style="color: var(--primary-dark);"></i>
                      Resource Person
                    </label>
                    <div class="text-muted small">
                      ${escapeHtml(act.RESOURCE_PERSON)}
                    </div>
                  </div>
                ` : `
                  <div>
                    <label class="small text-muted fw-semibold text-uppercase mb-1 d-flex align-items-center" style="font-size: 0.75rem; letter-spacing: 0.5px;">
                      <i class="bi bi-person-circle me-1" style="color: var(--primary-dark);"></i>
                      Resource Person
                    </label>
                    <div class="text-muted small">
                      Not specified
                    </div>
                  </div>
                `}
              </div>

              <!-- Reference Document Button -->
              ${act.REFERENCE_DOC ? `
                <div class="mt-auto pt-3 border-top">
                  <a href="${escapeHtml(act.REFERENCE_DOC)}" 
                     target="_blank" 
                     class="btn btn-sm w-100 rounded-pill fw-semibold d-flex align-items-center justify-content-center gap-2 text-white"
                     style="background: #0f1056; border: none; padding: 0.5rem 1rem;">
                    <i class="bi bi-file-earmark-text"></i>
                    View Reference Document
                  </a>
                </div>
              ` : `
                <div class="mt-auto pt-3 border-top">
                  <span class="text-muted small d-flex align-items-center justify-content-center">
                    <i class="bi bi-info-circle me-1"></i>
                    No reference document available
                  </span>
                </div>
              `}
            </div>
          </div>
        </div>
      `).join('');

    } catch (err) {
      console.error('Load recent activities error:', err);
      container.innerHTML = `
        <div class="col-12">
          <div class="alert alert-warning rounded-4 text-center py-4">
            <i class="bi bi-wifi-off display-6"></i>
            <p class="mt-3 mb-0">Failed to load activities.</p>
          </div>
        </div>
      `;
    }
  }

  async function loadStructure() {
    const container = document.getElementById('structure-container');
    // Structure page is now static, so container may not exist
    if (!container) {
      console.log('Structure page is static, no container found');
      return;
    }
    try {
      const data = await callServer('getImplementationStructure');
      
      if (!data.length) {
        container.innerHTML = `
          <div class="text-center py-5 text-muted">
            <i class="bi bi-inbox display-1 opacity-50"></i>
            <h5 class="mt-4">No structure data available</h5>
          </div>
        `;
        return;
      }

      // Group by level for better organization
      const groupedByLevel = {};
      data.forEach(row => {
        const level = row.LEVEL || 'Other';
        if (!groupedByLevel[level]) {
          groupedByLevel[level] = [];
        }
        groupedByLevel[level].push(row);
      });

      // Custom sort order: National, FMA, Regional, then others
      // Handle variations like "National Level", "FMA Level", "Regional Level"
      const getLevelPriority = (level) => {
        const levelUpper = level.toUpperCase();
        if (levelUpper.includes('NATIONAL')) return 1;
        if (levelUpper.includes('FMA')) return 2;
        if (levelUpper.includes('REGIONAL')) return 3;
        return 99; // Other levels come last
      };

      const levels = Object.keys(groupedByLevel).sort((a, b) => {
        const aPriority = getLevelPriority(a);
        const bPriority = getLevelPriority(b);
        
        // If priorities are different, sort by priority
        if (aPriority !== bPriority) return aPriority - bPriority;
        
        // If same priority (both are "other"), sort alphabetically
        return a.localeCompare(b);
      });

      // Determine level priority and icon
      const getLevelInfo = (level) => {
        const levelUpper = level.toUpperCase();
        if (levelUpper.includes('NATIONAL')) {
          return {
            priority: 1,
            icon: 'bi-building',
            cardClass: 'structure-card-national',
            colClass: 'col-md-6 col-lg-4',
            fontSize: '1.1rem'
          };
        } else if (levelUpper.includes('FMA')) {
          return {
            priority: 2,
            icon: 'bi-diagram-3',
            cardClass: 'structure-card-fma',
            colClass: 'col-md-6 col-lg-4',
            fontSize: '1rem'
          };
        } else if (levelUpper.includes('REGIONAL')) {
          return {
            priority: 3,
            icon: 'bi-geo-alt',
            cardClass: 'structure-card-regional',
            colClass: 'col-md-6 col-lg-4',
            fontSize: '0.95rem'
          };
        } else {
          return {
            priority: 4,
            icon: 'bi-layers',
            cardClass: 'structure-card-other',
            colClass: 'col-md-6 col-lg-4',
            fontSize: '0.9rem'
          };
        }
      };

      // Create accordion structure
      const accordionId = 'structureAccordion';
      container.innerHTML = `
        <div class="accordion" id="${accordionId}">
          ${levels.map((level, levelIndex) => {
            const items = groupedByLevel[level];
            const levelInfo = getLevelInfo(level);
            const itemId = `level-${levelInfo.priority}`;
            const headingId = `heading-${itemId}`;
            const collapseId = `collapse-${itemId}`;
            const isFirst = levelIndex === 0;
            
            return `
              <div class="accordion-item border-0 mb-3">
                <h2 class="accordion-header" id="${headingId}">
                  <button class="accordion-button ${isFirst ? '' : 'collapsed'}" type="button" 
                    data-bs-toggle="collapse" data-bs-target="#${collapseId}" 
                    aria-expanded="${isFirst ? 'true' : 'false'}" 
                    aria-controls="${collapseId}">
                    <div class="d-flex align-items-center w-100">
                      <i class="bi ${levelInfo.icon} me-3 fs-4" style="color: var(--primary-dark);"></i>
                      <div class="flex-grow-1">
                        <div class="d-flex align-items-center">
                          <span class="badge bg-primary text-white rounded-pill px-3 py-1 me-2">
                            Level ${levelInfo.priority}
                          </span>
                          <h5 class="mb-0 fw-bold">${escapeHtml(level)}</h5>
                        </div>
                        <small class="text-muted">${items.length} ${items.length === 1 ? 'component' : 'components'}</small>
                      </div>
                    </div>
                  </button>
                </h2>
                <div id="${collapseId}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}" 
                  aria-labelledby="${headingId}" data-bs-parent="#${accordionId}">
                  <div class="accordion-body p-4">
                    <div class="row g-4">
                      ${items.map(row => `
                        <div class="${levelInfo.colClass}">
                          <div class="glass-card p-4 h-100 structure-card ${levelInfo.cardClass} border-0">
                            <!-- Component Badge -->
                            <div class="mb-3">
                              <span class="badge rounded-pill px-3 py-2 text-white shadow-sm" style="background: var(--primary-dark); font-weight: 600; font-size: 0.75rem;">
                                ${escapeHtml(row.COMPONENT || 'Not Specified')}
                              </span>
                            </div>
                            
                            <!-- Full Name -->
                            <h5 class="fw-bold text-dark mb-3" style="font-size: ${levelInfo.fontSize}; line-height: 1.4; min-height: 2.5em;">
                              ${escapeHtml(row.FULL_NAME || 'Not Specified')}
                            </h5>

                            <!-- Head -->
                            <div class="mb-3">
                              <label class="small text-muted fw-semibold text-uppercase mb-1 d-flex align-items-center" style="font-size: 0.75rem; letter-spacing: 0.5px;">
                                <i class="bi bi-person-badge me-1" style="color: var(--primary-dark);"></i>
                                Head
                              </label>
                              <div class="text-dark fw-semibold">
                                ${escapeHtml(row.HEAD || 'Not Specified')}
                              </div>
                            </div>

                            <!-- Composition -->
                            <div>
                              <label class="small text-muted fw-semibold text-uppercase mb-1 d-flex align-items-center" style="font-size: 0.75rem; letter-spacing: 0.5px;">
                                <i class="bi bi-people-fill me-1" style="color: var(--primary-dark);"></i>
                                Composition
                              </label>
                              <div class="text-muted small" style="line-height: 1.6;">
                                ${escapeHtml(row.COMPOSITION || 'Not Specified')}
                              </div>
                            </div>
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    } catch (err) {
      console.error('Load structure error:', err);
      container.innerHTML = `
        <div class="alert alert-danger rounded-4 text-center py-4">
          <i class="bi bi-exclamation-triangle display-6"></i>
          <p class="mt-3 mb-0">Failed to load structure data. Please try again.</p>
        </div>
      `;
    }
  }

  async function loadMunicipalities() {
    const tbody = document.querySelector('#municipalities-table tbody');
    const table = tbody.closest('table');
    const filterPlaceholder = document.getElementById('filter-container-placeholder');
    table.classList.add('table-loading');

    try {
      const data = await callServer('getMunicipalities');

      // Extract unique FMAs, regions & provinces
      const fmas = [...new Set(data.map(r => r.FMA_ID).filter(Boolean))].sort();
      const regions = [...new Set(data.map(r => r.REGION).filter(Boolean))].sort();
      const provincesByRegion = {};
      data.forEach(row => {
        if (!provincesByRegion[row.REGION]) provincesByRegion[row.REGION] = new Set();
        if (row.PROVINCE) provincesByRegion[row.REGION].add(row.PROVINCE);
      });

      // Convert sets to sorted arrays
      Object.keys(provincesByRegion).forEach(region => {
        provincesByRegion[region] = [...provincesByRegion[region]].sort();
      });

      // Helper function to format FMA ID (avoid duplicate "FMA" prefix)
      const formatFMA = (fmaId) => {
        if (!fmaId) return '-';
        // If FMA_ID already starts with "FMA", return as-is, otherwise add "FMA " prefix
        return fmaId.toUpperCase().startsWith('FMA') ? fmaId : `FMA ${fmaId}`;
      };

      // === FILTER CONTROLS ===
      const filterHTML = `
        <div class="row g-3 mb-4">
          <div class="col-md-4">
            <label class="form-label fw-bold" style="color: #151269;">
              <i class="bi bi-diagram-3 me-1"></i>Filter by FMA
            </label>
            <select id="filter-fma" class="form-select shadow-sm">
              <option value="">All FMAs</option>
              ${fmas.map(f => `<option value="${escapeHtml(f)}">${escapeHtml(formatFMA(f))}</option>`).join('')}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-bold" style="color: #151269;">
              <i class="bi bi-geo-alt-fill me-1"></i>Filter by Region
            </label>
            <select id="filter-region" class="form-select shadow-sm">
              <option value="">All Regions</option>
              ${regions.map(r => `<option value="${escapeHtml(r)}">${escapeHtml(r)}</option>`).join('')}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-bold" style="color: #151269;">
              <i class="bi bi-building me-1"></i>Filter by Province
            </label>
            <select id="filter-province" class="form-select shadow-sm" disabled>
              <option value="">All Provinces (select region first)</option>
            </select>
          </div>
        </div>
      `;

      // Insert filters in placeholder
      if (filterPlaceholder) {
        filterPlaceholder.innerHTML = filterHTML;
      }

      const fmaSelect = document.getElementById('filter-fma');
      const regionSelect = document.getElementById('filter-region');
      const provinceSelect = document.getElementById('filter-province');

      // Populate provinces when region changes
      if (regionSelect) {
        regionSelect.addEventListener('change', () => {
          const selectedRegion = regionSelect.value;
          if (provinceSelect) {
            provinceSelect.innerHTML = '<option value="">All Provinces</option>';
            provinceSelect.disabled = !selectedRegion;

            if (selectedRegion && provincesByRegion[selectedRegion]) {
              provincesByRegion[selectedRegion].forEach(prov => {
                const opt = document.createElement('option');
                opt.value = prov;
                opt.textContent = prov;
                provinceSelect.appendChild(opt);
              });
            }
          }
          renderTable();
        });
      }

      if (provinceSelect) {
        provinceSelect.addEventListener('change', renderTable);
      }

      if (fmaSelect) {
        fmaSelect.addEventListener('change', renderTable);
      }

      // === RENDER FUNCTION ===
      function renderTable() {
        const fma = fmaSelect?.value || '';
        const region = regionSelect?.value || '';
        const province = provinceSelect?.value || '';

        let filtered = data;
        if (fma) filtered = filtered.filter(r => r.FMA_ID === fma);
        if (region) filtered = filtered.filter(r => r.REGION === region);
        if (province) filtered = filtered.filter(r => r.PROVINCE === province);

        tbody.innerHTML = filtered.length ? filtered.map(row => `
          <tr style="transition: background-color 0.2s ease;">
            <td class="ps-4">
              <span class="badge rounded-pill px-3 py-2 text-white fw-semibold" style="background: #0f1056;">
                ${escapeHtml(formatFMA(row.FMA_ID))}
              </span>
            </td>
            <td>${escapeHtml(row.REGION || '-')}</td>
            <td>${escapeHtml(row.PROVINCE || '-')}</td>
            <td class="pe-4 fw-semibold">${escapeHtml(row.MUNICIPALITY || '-')}</td>
          </tr>
        `).join('') : `
          <tr>
            <td colspan="4" class="text-center text-muted py-5">
              <i class="bi bi-inbox display-6 d-block mb-2 opacity-50"></i>
              <p class="mb-0">No municipalities match your filters</p>
            </td>
          </tr>
        `;
      }

      // Initial render
      renderTable();

    } catch (err) {
      console.error(err);
      tbody.innerHTML = '<tr><td colspan="4" class="text-danger text-center py-4">Error loading data</td></tr>';
    } finally {
      table.classList.remove('table-loading');
    }
  }

  async function loadActivities() {
    const timeline = document.getElementById('activities-timeline');
    const yearSel = document.getElementById('filter-year');
    const searchInput = document.getElementById('filter-search');

    try {
      const data = await callServer('getActivities');

      // Populate Year filter only
      const years = [...new Set(data.map(a => new Date(a.DATE_CONDUCTED).getFullYear()))].sort((a, b) => b - a);
      if (yearSel) {
        yearSel.innerHTML = '<option value="">All Years</option>' + years.map(y => `<option value="${y}">${y}</option>`).join('');
      }

      const render = () => {
        let filtered = data;
        
        // Apply year filter
        if (yearSel && yearSel.value) {
          filtered = filtered.filter(a => new Date(a.DATE_CONDUCTED).getFullYear() == yearSel.value);
        }
        
        // Apply search filter
        if (searchInput && searchInput.value.trim()) {
          const searchTerm = searchInput.value.toLowerCase().trim();
          filtered = filtered.filter(a => {
            const title = (a.ACTIVITY_TITLE || '').toLowerCase();
            const location = (a.LOCATION || '').toLowerCase();
            const resourcePerson = (a.RESOURCE_PERSON || '').toLowerCase();
            return title.includes(searchTerm) || location.includes(searchTerm) || resourcePerson.includes(searchTerm);
          });
        }
        
        filtered.sort((a, b) => new Date(b.DATE_CONDUCTED) - new Date(a.DATE_CONDUCTED));

        // ADD THIS LINE: Reset animation
        timeline.classList.add('timeline-reset');

        // Force reflow to restart animation
        void timeline.offsetWidth;

        timeline.innerHTML = filtered.length ? filtered.map((a, idx) => `
          <div class="timeline-item ${idx < filtered.length - 1 ? 'mb-5' : ''}">
            <div class="card border-0 shadow-lg rounded-4 overflow-hidden transition-all hover-lift" style="transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">
              <!-- Header Bar -->
              <div class="card-header border-0 p-0" style="background: #151269; height: 4px;"></div>
              
              <div class="card-body p-4">
                <!-- Date Badge -->
                <div class="mb-3">
                  <span class="badge rounded-pill px-3 py-2 text-white" style="background: #151269; font-weight: 600;">
                    <i class="bi bi-calendar3-event me-1"></i>
                    ${formatDate(a.DATE_CONDUCTED)}
                  </span>
                </div>

                <!-- Activity Title -->
                <div class="mb-4">
                  <label class="small text-muted fw-semibold text-uppercase mb-1" style="font-size: 0.75rem; letter-spacing: 0.5px;">Activity Title</label>
                  <h5 class="card-title fw-bold text-dark mb-0" style="font-size: 1.25rem; line-height: 1.4; color: #151269;">
                    ${escapeHtml(a.ACTIVITY_TITLE || 'Untitled Activity')}
                  </h5>
                </div>

                <!-- Details Section -->
                <div class="row g-3 mb-3">
                  <!-- Location -->
                  <div class="col-md-6">
                    <label class="small text-muted fw-semibold text-uppercase mb-1 d-flex align-items-center" style="font-size: 0.75rem; letter-spacing: 0.5px;">
                      <i class="bi bi-geo-alt-fill me-1" style="color: #151269;"></i>
                      Location
                    </label>
                    <div class="text-dark fw-semibold">
                      ${escapeHtml(a.LOCATION || 'Not specified')}
                    </div>
                  </div>

                  <!-- Resource Person -->
                  <div class="col-md-6">
                    <label class="small text-muted fw-semibold text-uppercase mb-1 d-flex align-items-center" style="font-size: 0.75rem; letter-spacing: 0.5px;">
                      <i class="bi bi-person-circle me-1" style="color: #151269;"></i>
                      Resource Person
                    </label>
                    <div class="text-dark fw-semibold">
                      ${escapeHtml(a.RESOURCE_PERSON || 'Not specified')}
                    </div>
                  </div>
                </div>

                <!-- Reference Document Button -->
                ${a.REFERENCE_DOC ? `
                  <div class="pt-3 border-top mt-3">
                    <a href="${escapeHtml(a.REFERENCE_DOC)}" 
                       target="_blank" 
                       class="btn btn-sm w-100 rounded-pill fw-semibold d-flex align-items-center justify-content-center gap-2 text-white"
                       style="background: #0f1056; border: none; padding: 0.5rem 1rem;">
                      <i class="bi bi-file-earmark-text"></i>
                      View Reference Document
                    </a>
                  </div>
                ` : `
                  <div class="pt-3 border-top mt-3">
                    <span class="text-muted small d-flex align-items-center justify-content-center">
                      <i class="bi bi-info-circle me-1"></i>
                      No reference document available
                    </span>
                  </div>
                `}
              </div>
            </div>
          </div>
        `).join('') : `
          <div class="text-center py-5 text-muted">
            <i class="bi bi-inbox display-1"></i>
            <p class="mt-3">No activities found.</p>
          </div>
        `;

        // REMOVE reset class after render
        setTimeout(() => timeline.classList.remove('timeline-reset'), 50);
      };

      if (yearSel) {
        yearSel.onchange = render;
      }
      if (searchInput) {
        searchInput.oninput = () => debounce(render, 300)();
      }
      render();
    } catch (err) {
      console.error('Load activities error:', err);
      timeline.innerHTML = `
        <div class="alert alert-danger rounded-3">
          <i class="bi bi-exclamation-triangle"></i> Failed to load activities.
        </div>
      `;
    }
  }

  async function loadDirectory(type) {
    currentDirType = type;
    const table = document.getElementById('dir-table');
    const thead = table.querySelector('thead');
    const tbody = table.querySelector('tbody');
    const searchInput = document.getElementById('dir-search');
    const exportBtn = document.getElementById('export-csv');

    // Show loading state immediately
    table.classList.add('table-loading');
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="text-center py-5">
          <div class="spinner-border" role="status" style="color: #151269;"></div>
          <p class="mt-2 text-muted">Loading ${type.charAt(0).toUpperCase() + type.slice(1)} directory...</p>
        </td>
      </tr>
    `;
    
    // Clear search input and reset filters
    if (searchInput) searchInput.value = '';
    
    // Reset all filter dropdowns
    const componentFilter = document.getElementById('dir-filter-component');
    const employmentFilter = document.getElementById('dir-filter-employment');
    const officeFilter = document.getElementById('dir-filter-office');
    const npmoComponentFilter = document.getElementById('dir-filter-npmo-component');
    
    if (componentFilter) componentFilter.value = '';
    if (employmentFilter) employmentFilter.value = '';
    if (officeFilter) officeFilter.value = '';
    if (npmoComponentFilter) npmoComponentFilter.value = '';
    
    // Update active tab button (no spinner, just update active state)
    document.querySelectorAll('#dirTabs button').forEach(btn => {
      const isActive = btn.dataset.type === type;
      btn.classList.toggle('active', isActive);
    });

    try {
      const data = await callServer('getDirectory', [type]);

      // Build full name for all types
      data.forEach(r => {
        r.fullName = `${r.GIVEN_NAME || ''} ${r.MIDDLE_INITIAL ? r.MIDDLE_INITIAL + '. ' : ''}${r.LAST_NAME || ''}`.trim();
      });

      // === CONFIG PER TYPE ===
      let config;
      if (type === 'internal') {
        config = {
          headers: ['Name', 'Component', 'Position', 'Employment', 'Email'],
          keys: ['fullName', 'COMPONENT', 'POSITION_DESIGNATION', 'EMPLOYMENT_TYPE', 'EMAIL']
        };
      } else if (type === 'external') {
        config = {
          headers: ['Name', 'Office', 'Position', 'FMA Lead', 'Email'],
          keys: ['fullName', 'OFFICE', 'POSITION_DESIGNATION', 'FMA_LEAD', 'EMAIL']
        };
      } else if (type === 'npmo') {
        config = {
          headers: ['Name', 'Office', 'Position', 'Component', 'Email'],
          keys: ['fullName', 'OFFICE', 'POSITION_DESIGNATION', 'COMPONENT', 'EMAIL']
        };
      } else {
        throw new Error('Invalid directory type');
      }

      const { headers, keys } = config;

      // Update table header
      thead.innerHTML = `<tr>${headers.map(h => `<th class="fw-semibold" style="color: #151269 !important; padding: 1rem 0.75rem;">${h}</th>`).join('')}</tr>`;

      // Hide/show filters based on type
      document.querySelectorAll('.dir-filter-internal, .dir-filter-npmo').forEach(el => el.style.display = 'none');
      
      let componentFilter, employmentFilter, officeFilter, npmoComponentFilter;
      
      if (type === 'internal') {
        // Show Internal filters
        document.querySelectorAll('.dir-filter-internal').forEach(el => el.style.display = 'block');
        componentFilter = document.getElementById('dir-filter-component');
        employmentFilter = document.getElementById('dir-filter-employment');
        
        // Populate Component filter
        const components = [...new Set(data.map(r => r.COMPONENT).filter(Boolean))].sort();
        if (componentFilter) {
          componentFilter.innerHTML = '<option value="">All Components</option>' +
            components.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
        }
        
        // Populate Employment Type filter
        const employmentTypes = [...new Set(data.map(r => r.EMPLOYMENT_TYPE).filter(Boolean))].sort();
        if (employmentFilter) {
          employmentFilter.innerHTML = '<option value="">All Types</option>' +
            employmentTypes.map(e => `<option value="${escapeHtml(e)}">${escapeHtml(e)}</option>`).join('');
        }
      } else if (type === 'external') {
        // Hide all filters for External (only search remains)
        // Filters are already hidden above
      } else if (type === 'npmo') {
        // Show NPMO filters
        document.querySelectorAll('.dir-filter-npmo').forEach(el => el.style.display = 'block');
        officeFilter = document.getElementById('dir-filter-office');
        npmoComponentFilter = document.getElementById('dir-filter-npmo-component');
        
        // Populate Office filter
        const offices = [...new Set(data.map(r => r.OFFICE).filter(Boolean))].sort();
        if (officeFilter) {
          officeFilter.innerHTML = '<option value="">All Offices</option>' +
            offices.map(o => `<option value="${escapeHtml(o)}">${escapeHtml(o)}</option>`).join('');
        }
        
        // Populate Component filter
        const components = [...new Set(data.map(r => r.COMPONENT).filter(Boolean))].sort();
        if (npmoComponentFilter) {
          npmoComponentFilter.innerHTML = '<option value="">All Components</option>' +
            components.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
        }
      }

      // Render function
      const render = () => {
        let filtered = data;
        const query = searchInput.value.toLowerCase();

        // Apply search filter
        if (query) {
          filtered = filtered.filter(r =>
            r.fullName.toLowerCase().includes(query) ||
            (r.EMAIL && r.EMAIL.toLowerCase().includes(query))
          );
        }
        
        // Apply type-specific filters
        if (type === 'internal') {
          const selectedComponent = componentFilter?.value || '';
          const selectedEmployment = employmentFilter?.value || '';
          
          if (selectedComponent) {
            filtered = filtered.filter(r => r.COMPONENT === selectedComponent);
          }
          if (selectedEmployment) {
            filtered = filtered.filter(r => r.EMPLOYMENT_TYPE === selectedEmployment);
          }
        } else if (type === 'npmo') {
          const selectedOffice = officeFilter?.value || '';
          const selectedComponent = npmoComponentFilter?.value || '';
          
          if (selectedOffice) {
            filtered = filtered.filter(r => r.OFFICE === selectedOffice);
          }
          if (selectedComponent) {
            filtered = filtered.filter(r => r.COMPONENT === selectedComponent);
          }
        }

        tbody.innerHTML = filtered.length ? filtered.map(r => `
          <tr>
            <td>${escapeHtml(r.fullName)}</td>
            <td>${escapeHtml(r[keys[1]] || '-')}</td>
            <td>${escapeHtml(r[keys[2]] || '-')}</td>
            <td>${escapeHtml(r[keys[3]] || '-')}</td>
            <td>${r.EMAIL ? `<a href="mailto:${r.EMAIL}" class="text-primary">${escapeHtml(r.EMAIL)}</a>` : '-'}</td>
          </tr>
        `).join('') : `
          <tr>
            <td colspan="5" class="text-center text-muted py-4">No contacts found</td>
          </tr>
        `;
      };

      // Bind events
      searchInput.oninput = () => debounce(render, 300)();
      
      if (componentFilter) componentFilter.onchange = render;
      if (employmentFilter) employmentFilter.onchange = render;
      if (officeFilter) officeFilter.onchange = render;
      if (npmoComponentFilter) npmoComponentFilter.onchange = render;

      // Export CSV
      exportBtn.onclick = async () => {
        const csv = await callServer('exportDirectoryToCSV', [type]);
        if (csv) {
          const a = document.createElement('a');
          a.href = csv;
          a.download = `${type}_directory_${new Date().toISOString().slice(0, 10)}.csv`;
          a.click();
          showToast('Directory exported as CSV!', 'success');
        }
      };

      // Initial render
      render();

    } catch (err) {
      console.error('Load directory error:', err);
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="text-danger text-center py-4">
            Failed to load directory. Please try again.
          </td>
        </tr>
      `;
    } finally {
      table.classList.remove('table-loading');
      
      // === UPDATE ACTIVE TAB ===
      document.querySelectorAll('#dirTabs button').forEach(btn => {
        const isActive = btn.dataset.type === type;
        btn.classList.toggle('active', isActive);
      });
    }
  }

  async function loadReferences() {
    const container = document.getElementById('references-list');
    const filtersPlaceholder = document.getElementById('ref-filters-placeholder');
    const paginationEl = document.getElementById('ref-pagination');
    const paginationControls = document.getElementById('ref-pagination-controls');
    const paginationInfo = document.getElementById('ref-pagination-info');
    const itemsPerPageSelect = document.getElementById('ref-items-per-page');
    
    // Pagination state
    let currentPage = 1;
    let itemsPerPage = 20;
    
    try {
      const data = await callServer('getReferenceFiles');
      
      // Extract unique categories
      const categories = [...new Set(data.map(r => r.CATEGORY || r.Category || '').filter(Boolean))].sort();
      
      // Create filters HTML
      const filtersHTML = `
        <div class="row g-3 align-items-end">
          <div class="col-md-6">
            <label class="form-label fw-bold mb-2" style="color: #151269;">
              <i class="bi bi-search me-1"></i>Search
            </label>
            <div class="input-group shadow-sm">
              <span class="input-group-text bg-white border-end-0"><i class="bi bi-search text-muted"></i></span>
              <input type="text" class="form-control border-start-0 ps-0" id="ref-search" placeholder="Search files...">
            </div>
          </div>
          <div class="col-md-6">
            <label class="form-label fw-bold mb-2" style="color: #151269;">
              <i class="bi bi-funnel me-1"></i>Category
            </label>
            <select class="form-select shadow-sm" id="ref-filter-category">
              <option value="">All Categories</option>
              ${categories.map(c => `<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('')}
            </select>
          </div>
        </div>
      `;
      
      // Insert filters
      if (filtersPlaceholder) {
        filtersPlaceholder.innerHTML = filtersHTML;
      }
      
      const search = document.getElementById('ref-search');
      const categoryFilter = document.getElementById('ref-filter-category');
      
      // Function to render pagination controls
      const renderPagination = (totalItems, currentPageNum, itemsPerPageNum) => {
        const totalPages = Math.ceil(totalItems / itemsPerPageNum);
        
        if (totalPages <= 1) {
          if (paginationEl) paginationEl.classList.add('d-none');
          return;
        }
        
        if (paginationEl) paginationEl.classList.remove('d-none');
        
        // Update pagination info
        const start = totalItems === 0 ? 0 : (currentPageNum - 1) * itemsPerPageNum + 1;
        const end = Math.min(currentPageNum * itemsPerPageNum, totalItems);
        if (paginationInfo) {
          paginationInfo.textContent = `Showing ${start}-${end} of ${totalItems}`;
        }
        
        // Build pagination buttons
        let paginationHTML = '';
        
        // Previous button
        paginationHTML += `
          <li class="page-item ${currentPageNum === 1 ? 'disabled' : ''}">
            <a class="page-link" href="javascript:void(0)" data-page="${currentPageNum - 1}" style="color: #151269;">
              <i class="bi bi-chevron-left"></i>
            </a>
          </li>
        `;
        
        // Page number buttons
        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPageNum - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
        
        if (endPage - startPage < maxVisiblePages - 1) {
          startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }
        
        if (startPage > 1) {
          paginationHTML += `
            <li class="page-item">
              <a class="page-link" href="javascript:void(0)" data-page="1" style="color: #151269;">1</a>
            </li>
          `;
          if (startPage > 2) {
            paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
          }
        }
        
        for (let i = startPage; i <= endPage; i++) {
          paginationHTML += `
            <li class="page-item ${i === currentPageNum ? 'active' : ''}">
              <a class="page-link" href="javascript:void(0)" data-page="${i}" 
                 style="${i === currentPageNum ? 'background: #151269; border-color: #151269; color: white;' : 'color: #151269;'}">
                ${i}
              </a>
            </li>
          `;
        }
        
        if (endPage < totalPages) {
          if (endPage < totalPages - 1) {
            paginationHTML += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
          }
          paginationHTML += `
            <li class="page-item">
              <a class="page-link" href="javascript:void(0)" data-page="${totalPages}" style="color: #151269;">${totalPages}</a>
            </li>
          `;
        }
        
        // Next button
        paginationHTML += `
          <li class="page-item ${currentPageNum === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="javascript:void(0)" data-page="${currentPageNum + 1}" style="color: #151269;">
              <i class="bi bi-chevron-right"></i>
            </a>
          </li>
        `;
        
        if (paginationControls) {
          paginationControls.innerHTML = paginationHTML;
        }
      };
      
      // Function to go to a specific page
      const goToPage = (pageNum) => {
        const totalPages = Math.ceil(getFilteredData().length / itemsPerPage);
        if (pageNum >= 1 && pageNum <= totalPages) {
          currentPage = pageNum;
          render();
        }
      };
      
      // Function to get filtered data
      const getFilteredData = () => {
        const q = search?.value.toLowerCase() || '';
        const selectedCategory = categoryFilter?.value || '';
        
        let filtered = data;
        
        // Apply search filter
        if (q) {
          filtered = filtered.filter(r => r.DOCUMENT_TITLE.toLowerCase().includes(q));
        }
        
        // Apply category filter
        if (selectedCategory) {
          filtered = filtered.filter(r => (r.CATEGORY || r.Category || '') === selectedCategory);
        }
        
        // Sort alphabetically by document title
        filtered.sort((a, b) => {
          const titleA = (a.DOCUMENT_TITLE || '').toLowerCase();
          const titleB = (b.DOCUMENT_TITLE || '').toLowerCase();
          return titleA.localeCompare(titleB);
        });
        
        return filtered;
      };
      
      const render = () => {
        const filtered = getFilteredData();
        const totalItems = filtered.length;
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        
        // Reset to page 1 if current page is out of bounds
        if (currentPage > totalPages && totalPages > 0) {
          currentPage = 1;
        }
        
        // Get paginated data
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const paginatedData = filtered.slice(startIndex, endIndex);
        
        // Render items
        container.innerHTML = paginatedData.length ? paginatedData.map(r => {
          const category = r.CATEGORY || r.Category || 'Uncategorized';
          return `
          <div class="card border-0 shadow-sm rounded-3 overflow-hidden transition-all hover-lift" style="transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);">
            <!-- Header Bar -->
            <div class="card-header border-0 p-0" style="background: #151269; height: 4px;"></div>
            
            <div class="card-body p-4">
              <div class="d-flex justify-content-between align-items-start mb-3">
                <div class="flex-grow-1 me-3">
                  <div class="d-flex align-items-center mb-2">
                    <div class="rounded-circle p-2 me-3 flex-shrink-0" style="background: rgba(21, 18, 105, 0.1);">
                      <i class="bi bi-file-earmark-pdf fs-5" style="color: #151269;"></i>
                    </div>
                    <div class="flex-grow-1">
                      <h6 class="card-title mb-1 fw-bold" style="color: #151269; font-size: 1.1rem;">${escapeHtml(r.DOCUMENT_TITLE)}</h6>
                      <span class="badge rounded-pill px-3 py-1 text-white" style="background: #0f1056; font-size: 0.75rem; font-weight: 600;">
                        <i class="bi bi-tag me-1"></i>${escapeHtml(category)}
                      </span>
                    </div>
                  </div>
                </div>
                <a href="${r.FILE_URL}" 
                   class="btn btn-sm rounded-pill fw-semibold d-flex align-items-center gap-2 text-white flex-shrink-0" 
                   style="background: #0f1056; border: none; padding: 0.5rem 1.5rem; transition: all 0.3s ease;"
                   target="_blank">
                  <i class="bi bi-box-arrow-up-right"></i>
                  Open Document
                </a>
              </div>
            </div>
          </div>
        `;
        }).join('') : `
          <div class="text-center py-5 text-muted">
            <i class="bi bi-inbox display-6 d-block mb-2 opacity-50"></i>
            <p class="mb-0">No files found.</p>
          </div>
        `;
        
        // Render pagination
        renderPagination(totalItems, currentPage, itemsPerPage);
      };
      
      // Event handlers
      if (search) {
        search.oninput = () => {
          currentPage = 1; // Reset to first page on search
          debounce(render, 300)();
        };
      }
      
      if (categoryFilter) {
        categoryFilter.onchange = () => {
          currentPage = 1; // Reset to first page on filter change
          render();
        };
      }
      
      if (itemsPerPageSelect) {
        itemsPerPageSelect.onchange = () => {
          itemsPerPage = parseInt(itemsPerPageSelect.value) || 20;
          currentPage = 1; // Reset to first page when changing items per page
          render();
        };
      }
      
      // Use event delegation for pagination buttons
      if (paginationControls) {
        paginationControls.addEventListener('click', (e) => {
          const link = e.target.closest('.page-link[data-page]');
          if (link && !link.closest('.disabled')) {
            e.preventDefault();
            e.stopPropagation();
            const pageNum = parseInt(link.getAttribute('data-page'));
            if (!isNaN(pageNum)) {
              goToPage(pageNum);
            }
            return false;
          }
        });
      }
      
      render();
    } catch (err) {
      if (container) container.innerHTML = '<p class="text-danger">Failed to load files.</p>';
      if (paginationEl) paginationEl.classList.add('d-none');
    }
  }

  async function loadFMAProfile() {
    const container = document.getElementById('fma-profile-container');
    
    try {
      const data = await callServer('getFMAProfile');
      
      if (!data || data.length === 0) {
        container.innerHTML = `
          <div class="text-center py-5 text-muted">
            <i class="bi bi-inbox display-6 d-block mb-2 opacity-50"></i>
            <p class="mb-0">No FMA profile data available.</p>
          </div>
        `;
        return;
      }

      // Group rows by Key Characteristics (case-insensitive, trimmed)
      const grouped = {};
      data.forEach(row => {
        const keyChar = (row.KEY_CHARACTERISTICS || row['Key Characteristics'] || '').toString().trim();
        const normalizedKey = keyChar.toLowerCase();
        
        if (!grouped[normalizedKey]) {
          grouped[normalizedKey] = {
            keyChar: keyChar || 'Not Specified',
            rows: []
          };
        }
        
        // Get FMA values - try multiple possible column names and preserve exact formatting
        let fma06 = row['FMA 06'] || row['FMA_06'] || row['FMA06'] || row['FMA 6'] || row['FMA_6'] || row['FMA6'] || '';
        let fma09 = row['FMA 09'] || row['FMA_09'] || row['FMA09'] || row['FMA 9'] || row['FMA_9'] || row['FMA9'] || '';
        
        // Preserve the exact value from the sheet (convert to string and trim leading/trailing whitespace)
        fma06 = fma06 !== '' ? String(fma06).trim() : 'Not Specified';
        fma09 = fma09 !== '' ? String(fma09).trim() : 'Not Specified';
        
        grouped[normalizedKey].rows.push({
          measurement: row.MEASUREMENT || 'Not Specified',
          fma06: fma06,
          fma09: fma09
        });
      });

      // Create comparison table with merged rows
      const tableRows = [];
      Object.keys(grouped).sort().forEach(normalizedKey => {
        const group = grouped[normalizedKey];
        const rowCount = group.rows.length;
        
        group.rows.forEach((row, index) => {
          const isFirstRow = index === 0;
          const rowspan = isFirstRow ? rowCount : 0;
          
          tableRows.push(`
            <tr style="transition: background-color 0.2s ease;">
              ${isFirstRow ? `
                <td class="fw-semibold" style="padding: 1rem 0.75rem; vertical-align: middle; text-align: left;" rowspan="${rowCount}">
                  ${escapeHtml(group.keyChar)}
                </td>
              ` : ''}
              <td style="padding: 1rem 0.75rem; vertical-align: middle; color: #6c757d; text-align: left;">
                ${escapeHtml(row.measurement)}
              </td>
              <td class="fw-semibold" style="padding: 1rem 0.75rem; vertical-align: middle; color: #151269; white-space: pre-wrap; text-align: left;">${escapeHtml(row.fma06)}</td>
              <td class="fw-semibold" style="padding: 1rem 0.75rem; vertical-align: middle; color: #151269; white-space: pre-wrap; text-align: left;">${escapeHtml(row.fma09)}</td>
            </tr>
          `);
        });
      });

      container.innerHTML = `
        <div class="table-responsive rounded-3 border shadow-sm">
          <table class="table table-hover mb-0 align-middle">
            <thead style="background: #f8f9fa;">
              <tr>
                <th class="fw-semibold" style="color: #151269 !important; padding: 1rem 0.75rem; width: 30%; text-align: left;">Key Characteristics</th>
                <th class="fw-semibold" style="color: #151269 !important; padding: 1rem 0.75rem; width: 20%; text-align: left;">Measurement</th>
                <th class="fw-semibold" style="color: #151269 !important; padding: 1rem 0.75rem; width: 25%; text-align: left;">
                  <span class="badge rounded-pill px-3 py-2 text-white" style="background: #0f1056;">
                    FMA 06
                  </span>
                </th>
                <th class="fw-semibold" style="color: #151269 !important; padding: 1rem 0.75rem; width: 25%; text-align: left;">
                  <span class="badge rounded-pill px-3 py-2 text-white" style="background: #0f1056;">
                    FMA 09
                  </span>
                </th>
              </tr>
            </thead>
            <tbody>
              ${tableRows.join('')}
            </tbody>
          </table>
        </div>
      `;
    } catch (err) {
      console.error('Load FMA Profile error:', err);
      container.innerHTML = `
        <div class="alert alert-danger rounded-4 text-center py-4">
          <i class="bi bi-exclamation-triangle display-6"></i>
          <p class="mt-3 mb-0">Failed to load FMA profile data. Please try again.</p>
        </div>
      `;
    }
  }

  // Page-based search mapping
  const PAGE_SEARCH_MAP = {
    'structure': {
      title: 'Implementation Structure',
      route: '#structure',
      icon: 'bi-diagram-3',
      keywords: ['structure', 'implementation', 'npmo', 'rpiu', 'fcu', 'organization', 'hierarchy', 'national', 'fma', 'regional', 'bfar', 'component'],
      description: 'View the organizational structure and implementation framework of the FishCRRM Component.'
    },
    'activities': {
      title: 'Activities',
      route: '#activities',
      icon: 'bi-calendar-event',
      keywords: ['activity', 'activities', 'training', 'meeting', 'event', 'workshop', 'seminar', 'conference', 'coordination', 'conducted', 'timeline', 'schedule', 'date'],
      description: 'Explore activities, trainings, and coordination meetings conducted under the FishCRRM Component.'
    },
    'directory': {
      title: 'Directory',
      route: '#directory',
      icon: 'bi-people',
      keywords: ['directory', 'contact', 'personnel', 'staff', 'employee', 'team', 'member', 'email', 'phone', 'internal', 'external', 'npmo', 'directory', 'people'],
      description: 'Find contact information for internal staff, external partners, and NPMO personnel.'
    },
    'references': {
      title: 'References',
      route: '#references',
      icon: 'bi-file-earmark-text',
      keywords: ['reference', 'references', 'document', 'documents', 'file', 'files', 'pdf', 'resource', 'materials', 'publication', 'report', 'category'],
      description: 'Access reference documents, reports, and materials related to the FishCRRM Component.'
    },
    'fmaprofile': {
      title: 'FMA Profile',
      route: '#fmaprofile',
      icon: 'bi-bar-chart-line',
      keywords: ['fma profile', 'fma 06', 'fma 09', 'fma-06', 'fma-09', 'characteristics', 'measurement', 'profile', 'fma', 'statistics', 'data'],
      description: 'View detailed characteristics and measurements for FMA 06 and FMA 09.'
    },
    'learnmore': {
      title: 'Learn More',
      route: '#learnmore',
      icon: 'bi-info-circle',
      keywords: ['learn more', 'about', 'overview', 'project', 'fishcrrm', 'component', 'intervention', 'coverage', 'fishcore', 'information', 'details'],
      description: 'Learn more about the FishCRRM 1.1 Component, its interventions, and coverage areas.'
    },
    'about': {
      title: 'About',
      route: '#about',
      icon: 'bi-question-circle',
      keywords: ['about', 'help', 'guide', 'how to', 'knowledge base', 'usage', 'tutorial', 'documentation'],
      description: 'Learn how to use the Knowledge Base and find information about the system.'
    }
  };

  // Map sheet names to pages
  const SHEET_TO_PAGE_MAP = {
    'Implementation_Structure': { page: 'structure', title: 'Implementation Structure', icon: 'bi-diagram-3' },
    'FMA_6_&_9_Municipalities': { page: 'fmamunicipalities', title: 'FMA Municipalities', icon: 'bi-diagram-3' },
    'Activities_Conducted': { page: 'activities', title: 'Activities', icon: 'bi-calendar-event' },
    'Internal_Directory': { page: 'directory', title: 'Directory (Internal)', icon: 'bi-people' },
    'External_Directory': { page: 'directory', title: 'Directory (External)', icon: 'bi-people' },
    'NPMO_Directory': { page: 'directory', title: 'Directory (NPMO)', icon: 'bi-people' },
    'Reference_Files': { page: 'references', title: 'References', icon: 'bi-file-earmark-text' },
    'FMA_Profile': { page: 'fmaprofile', title: 'FMA Profile', icon: 'bi-bar-chart-line' }
  };

  // Helper function to format content result
  function formatContentResult(result, pageInfo) {
    const route = `#${pageInfo.page}`;
    let preview = '';
    let matchedValue = '';

    // Get the matched field value for preview
    if (result._field && result[result._field]) {
      matchedValue = String(result[result._field]);
      preview = matchedValue.length > 100 ? matchedValue.substring(0, 100) + '...' : matchedValue;
    } else {
      // Try to get any relevant field value
      const fields = Object.keys(result).filter(k => !k.startsWith('_') && result[k]);
      if (fields.length > 0) {
        matchedValue = String(result[fields[0]]);
        preview = matchedValue.length > 100 ? matchedValue.substring(0, 100) + '...' : matchedValue;
      }
    }

    return {
      type: 'content',
      title: pageInfo.title,
      route: route,
      icon: pageInfo.icon,
      preview: preview,
      matchedField: result._field || '',
      score: result._score || 0
    };
  }

  async function loadSearchResults(hash = '') {
    const params = new URLSearchParams(hash.split('?')[1] || '');
    const query = params.get('q') || '';
    const queryEl = document.getElementById('search-query');
    const resultsEl = document.getElementById('search-results');
    const recentSearchesEl = document.getElementById('recent-searches');

    // Load recent searches
    const recent = JSON.parse(localStorage.getItem('recentSearches') || '[]');
    if (recentSearchesEl) {
      if (recent.length > 0) {
        recentSearchesEl.innerHTML = recent.slice(0, 5).map(s => `
          <a href="#" onclick="globalSearch('${escapeHtml(s)}'); return false;" class="d-block text-decoration-none text-muted small mb-2">
            <i class="bi bi-arrow-return-left me-2"></i>${escapeHtml(s)}
          </a>
        `).join('');
      } else {
        recentSearchesEl.innerHTML = '<p class="text-muted small mb-0">No recent searches.</p>';
      }
    }

    if (!query) {
      if (queryEl) queryEl.innerHTML = 'Enter a search term to find relevant pages.';
      if (resultsEl) {
        resultsEl.innerHTML = `
          <div class="text-center py-5 text-muted">
            <i class="bi bi-search display-6 d-block mb-3 opacity-50"></i>
            <p class="mb-0">Start typing to search for pages and content.</p>
          </div>
        `;
      }
      return;
    }

    if (queryEl) queryEl.innerHTML = `Search results for: <strong style="color: #151269;">${escapeHtml(query)}</strong>`;
    if (resultsEl) resultsEl.innerHTML = '<div class="text-center py-4"><div class="spinner-border" role="status" style="color: #151269;"></div><p class="mt-2 text-muted small">Searching...</p></div>';

    try {
      const queryLower = query.toLowerCase().trim();
      const allResults = [];

      // 1. Search through page mappings (keyword-based)
      Object.keys(PAGE_SEARCH_MAP).forEach(pageKey => {
        const page = PAGE_SEARCH_MAP[pageKey];
        let matchScore = 0;
        const matchedKeywords = [];

        // Check if query matches title exactly or partially
        const titleLower = page.title.toLowerCase();
        if (titleLower === queryLower) {
          matchScore += 20; // Exact title match
          matchedKeywords.push(page.title);
        } else if (titleLower.includes(queryLower)) {
          matchScore += 15; // Title contains query
          matchedKeywords.push(page.title);
        } else if (queryLower.includes(titleLower)) {
          matchScore += 12; // Query contains title
          matchedKeywords.push(page.title);
        }

        // Check if query matches any keyword
        page.keywords.forEach(keyword => {
          const keywordLower = keyword.toLowerCase();
          if (keywordLower === queryLower) {
            matchScore += 10; // Exact keyword match
            matchedKeywords.push(keyword);
          } else if (keywordLower.includes(queryLower)) {
            matchScore += 5; // Keyword contains query
            matchedKeywords.push(keyword);
          } else if (queryLower.includes(keywordLower)) {
            matchScore += 3; // Query contains keyword
            matchedKeywords.push(keyword);
          }
        });

        // Check route/page key match
        if (pageKey === queryLower || pageKey.includes(queryLower) || queryLower.includes(pageKey)) {
          matchScore += 8;
        }

        if (matchScore > 0) {
          allResults.push({
            type: 'page',
            ...page,
            score: matchScore,
            matchedKeywords: [...new Set(matchedKeywords)].slice(0, 3) // Remove duplicates
          });
        }
      });
      
      console.log('Page-based results:', allResults.length);

      // 2. Search through sheet data (content-based)
      try {
        const searchResponse = await callServer('searchAll', [query]);
        console.log('Search response:', searchResponse);
        
        if (searchResponse && searchResponse.results && searchResponse.results.length > 0) {
          const sheetResults = searchResponse.results;
          console.log('Sheet results found:', sheetResults.length);
          
          // Group results by sheet and map to pages
          const contentResultsByPage = {};
          
          sheetResults.forEach(result => {
            console.log('Processing result:', result._sheet, result);
            const pageInfo = SHEET_TO_PAGE_MAP[result._sheet];
            if (pageInfo) {
              const pageKey = pageInfo.page;
              if (!contentResultsByPage[pageKey]) {
                contentResultsByPage[pageKey] = {
                  pageInfo: pageInfo,
                  results: []
                };
              }
              contentResultsByPage[pageKey].results.push(result);
            } else {
              console.log('No page mapping found for sheet:', result._sheet);
            }
          });

          // Add content results grouped by page
          Object.keys(contentResultsByPage).forEach(pageKey => {
            const { pageInfo, results } = contentResultsByPage[pageKey];
            // Sort results by score
            results.sort((a, b) => (b._score || 0) - (a._score || 0));
            const topResult = results[0]; // Get the highest scored result
            const contentResult = formatContentResult(topResult, pageInfo);
            contentResult.matchCount = results.length;
            contentResult.score = (topResult._score || 0) + 5; // Boost content results slightly
            // Store all matching items for display
            contentResult.matchingItems = results.map(r => {
              // Get the matched field value or a relevant field value
              let displayValue = '';
              if (r._field && r[r._field]) {
                displayValue = String(r[r._field]);
              } else {
                // Try to get a meaningful field value
                const fields = Object.keys(r).filter(k => !k.startsWith('_') && r[k]);
                if (fields.length > 0) {
                  // Prefer name fields, then title fields, then first available
                  const nameField = fields.find(f => f.includes('NAME') || f.includes('TITLE') || f.includes('MUNICIPALITY'));
                  displayValue = String(r[nameField || fields[0]]);
                }
              }
              return {
                value: displayValue,
                field: r._field || '',
                score: r._score || 0
              };
            }).filter(item => item.value); // Remove empty items
            allResults.push(contentResult);
          });
        } else {
          console.log('No sheet results found');
        }
      } catch (err) {
        console.error('Error searching sheet data:', err);
        // Continue with page-based results only
      }

      console.log('All results before processing:', allResults.length, allResults);

      // Sort all results by score
      allResults.sort((a, b) => (b.score || 0) - (a.score || 0));

      // Remove duplicates (same route) - keep highest score, but merge matching items
      const seenRoutes = new Map();
      allResults.forEach(result => {
        if (result && result.route) {
          if (!seenRoutes.has(result.route)) {
            seenRoutes.set(result.route, result);
          } else {
            const existing = seenRoutes.get(result.route);
            // If new result has higher score, replace it
            if ((result.score || 0) > (existing.score || 0)) {
              seenRoutes.set(result.route, result);
            } else if (result.matchingItems && result.matchingItems.length > 0) {
              // If existing doesn't have matching items but new one does, merge them
              if (!existing.matchingItems || existing.matchingItems.length === 0) {
                existing.matchingItems = result.matchingItems;
                existing.matchCount = result.matchCount || existing.matchCount;
              } else {
                // Merge matching items, avoiding duplicates
                const existingValues = new Set(existing.matchingItems.map(m => m.value));
                result.matchingItems.forEach(item => {
                  if (!existingValues.has(item.value)) {
                    existing.matchingItems.push(item);
                    existingValues.add(item.value);
                  }
                });
                existing.matchCount = existing.matchingItems.length;
              }
            }
          }
        }
      });

      const uniqueResults = Array.from(seenRoutes.values());
      
      // Sort again after deduplication
      uniqueResults.sort((a, b) => (b.score || 0) - (a.score || 0));
      
      console.log('Unique results after processing:', uniqueResults.length, uniqueResults);
      
      // Fallback: if no results but we have page matches, show them anyway
      if (uniqueResults.length === 0 && allResults.length > 0) {
        console.warn('Deduplication removed all results, using original results');
        uniqueResults.push(...allResults.slice(0, 10));
      }

      if (resultsEl) {
        if (uniqueResults.length > 0) {
          resultsEl.innerHTML = `
            <h5 class="fw-bold mb-4" style="color: #151269;">
              <i class="bi bi-check-circle me-2"></i>Found ${uniqueResults.length} ${uniqueResults.length === 1 ? 'result' : 'results'}
            </h5>
            <div class="vstack gap-3">
              ${uniqueResults.map(result => {
                if (result.type === 'content') {
                  return `
                    <div class="card border-0 shadow-sm hover-lift" style="transition: all 0.3s ease;">
                      <div class="card-body p-4">
                        <div class="d-flex align-items-start">
                          <div class="text-white rounded-circle p-3 me-3 shadow-sm" style="background: #151269; min-width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                            <i class="${result.icon} fs-4"></i>
                          </div>
                          <div class="flex-grow-1">
                            <h5 class="card-title fw-bold mb-2" style="color: #151269;">
                              <a href="${result.route}" class="text-decoration-none" style="color: #151269;">${escapeHtml(result.title)}</a>
                              ${result.matchCount > 1 ? `<span class="badge rounded-pill ms-2" style="background: rgba(21, 18, 105, 0.1); color: #151269;">${result.matchCount} matches</span>` : ''}
                            </h5>
                            ${result.preview ? `
                              <p class="card-text text-muted mb-2">
                                <small><i class="bi bi-quote me-1"></i>${escapeHtml(result.preview)}</small>
                              </p>
                            ` : ''}
                            ${result.matchedField ? `
                              <small class="text-muted d-block mb-3">
                                <i class="bi bi-tag me-1"></i>Found in: <strong>${escapeHtml(result.matchedField)}</strong>
                              </small>
                            ` : ''}
                            ${result.matchingItems && result.matchingItems.length > 0 ? `
                              <div class="mb-3">
                                <small class="text-muted d-block mb-2 fw-semibold">
                                  <i class="bi bi-list-ul me-1"></i>Matching Items:
                                </small>
                                <div class="d-flex flex-wrap gap-2" style="max-width: 100%; word-wrap: break-word;">
                                  ${result.matchingItems.slice(0, 10).map(item => {
                                    const displayValue = String(item.value).length > 50 
                                      ? String(item.value).substring(0, 50) + '...' 
                                      : String(item.value);
                                    return `
                                      <span class="badge rounded-pill px-2 py-1" style="background: rgba(21, 18, 105, 0.15); color: #151269; font-size: 0.8rem; max-width: 100%; word-break: break-word; white-space: normal;">
                                        <i class="bi bi-check-circle me-1"></i>${escapeHtml(displayValue)}
                                      </span>
                                    `;
                                  }).join('')}
                                  ${result.matchingItems.length > 10 ? `
                                    <span class="badge rounded-pill px-2 py-1 text-muted" style="background: rgba(0, 0, 0, 0.05); font-size: 0.8rem;">
                                      +${result.matchingItems.length - 10} more
                                    </span>
                                  ` : ''}
                                </div>
                              </div>
                            ` : ''}
                            <a href="${result.route}" class="btn btn-sm" style="background: #0f1056; color: white;">
                              <i class="bi bi-arrow-right me-1"></i>View Page
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  `;
                } else {
                  return `
                    <div class="card border-0 shadow-sm hover-lift" style="transition: all 0.3s ease;">
                      <div class="card-body p-4">
                        <div class="d-flex align-items-start">
                          <div class="text-white rounded-circle p-3 me-3 shadow-sm" style="background: #151269; min-width: 60px; height: 60px; display: flex; align-items: center; justify-content: center;">
                            <i class="${result.icon} fs-4"></i>
                          </div>
                          <div class="flex-grow-1">
                            <h5 class="card-title fw-bold mb-2" style="color: #151269;">
                              <a href="${result.route}" class="text-decoration-none" style="color: #151269;">${result.title}</a>
                            </h5>
                            <p class="card-text text-muted mb-3">${result.description}</p>
                            ${result.matchedKeywords && result.matchedKeywords.length > 0 ? `
                              <div class="mb-3">
                                <small class="text-muted d-block mb-1">Matched keywords:</small>
                                <div class="d-flex flex-wrap gap-2">
                                  ${result.matchedKeywords.map(kw => `
                                    <span class="badge rounded-pill" style="background: rgba(21, 18, 105, 0.1); color: #151269;">${escapeHtml(kw)}</span>
                                  `).join('')}
                                </div>
                              </div>
                            ` : ''}
                            <a href="${result.route}" class="btn btn-sm" style="background: #0f1056; color: white;">
                              <i class="bi bi-arrow-right me-1"></i>View Page
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  `;
                }
              }).join('')}
            </div>
          `;
        } else {
          resultsEl.innerHTML = `
            <div class="text-center py-5">
              <i class="bi bi-search display-6 d-block mb-3 text-muted opacity-50"></i>
              <h5 class="fw-bold mb-2" style="color: #151269;">No results found</h5>
              <p class="text-muted mb-4">We couldn't find any pages or content matching "<strong>${escapeHtml(query)}</strong>".</p>
              <div class="d-flex justify-content-center gap-2 flex-wrap">
                <a href="#structure" class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-diagram-3 me-1"></i>Structure
                </a>
                <a href="#fmamunicipalities" class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-diagram-3 me-1"></i>FMA Municipalities
                </a>
                <a href="#activities" class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-calendar-event me-1"></i>Activities
                </a>
                <a href="#directory" class="btn btn-outline-primary btn-sm">
                  <i class="bi bi-people me-1"></i>Directory
                </a>
              </div>
            </div>
          `;
        }
      }
    } catch (err) {
      console.error('Search error:', err);
      if (resultsEl) {
        resultsEl.innerHTML = `
          <div class="alert alert-danger rounded-4">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Search failed. Please try again.
          </div>
        `;
      }
    }
  }

  window.globalSearch = (query) => {
    if (!query.trim()) return;
    const recent = JSON.parse(localStorage.getItem('recentSearches') || '[]');
    const filtered = recent.filter(s => s !== query).slice(0, 4);
    localStorage.setItem('recentSearches', JSON.stringify([query, ...filtered]));
    navigate('#search?q=' + encodeURIComponent(query));
  };

  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // Initialize on page load
  function initializeApp() {
    // Priority: 1. URL hash, 2. localStorage, 3. default to home
    let hash = window.location.hash;
    
    // If no hash in URL, try to restore from localStorage
    if (!hash || hash === '#') {
      try {
        const lastPage = localStorage.getItem('lastPage');
        if (lastPage && lastPage !== '#') {
          hash = lastPage;
          // Update URL to match stored page
          if (window.history && window.history.replaceState) {
            window.history.replaceState(null, '', hash);
          }
        } else {
          hash = '#home';
        }
      } catch (e) {
        console.warn('localStorage not available:', e);
        hash = '#home';
      }
    }
    
    // Navigate to the determined page
    navigate(hash);
  }

  // Handle page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
  } else {
    // DOM is already loaded
    initializeApp();
  }

  // Also handle hash changes (e.g., when user manually changes URL)
  window.addEventListener('hashchange', () => {
    if (location.hash) {
      navigate(location.hash);
    }
  });
</script>